name: Sync Fork

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0  # 获取完整历史记录

      - name: Setup Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          # 移除可能已存在的上游仓库
          git remote remove upstream || true
          # 添加上游仓库
          git remote add upstream https://github.com/deepseek-ai/DeepSeek-V3.git
          # 获取上游所有分支
          git fetch upstream --quiet

      - name: Try to merge upstream changes
        run: |
          # 确保在 main 分支
          git checkout main
          # 尝试合并上游更改
          if git merge --ff-only upstream/main; then
            echo "✅ Fast-forward merge successful"
          else
            echo "⚠️ Fast-forward not possible, trying merge commit"
            # 设置合并策略，避免交互式提示
            git merge upstream/main --no-edit --strategy-option theirs || {
              echo "❌ Merge failed, resetting and forcing update"
              git reset --hard upstream/main
            }
          fi

      - name: Push changes to fork
        run: |
          git push origin main
